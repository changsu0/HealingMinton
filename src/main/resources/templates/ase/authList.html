<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <body>
  <div class="content-body">
    <div class="container-fluid">
      <form id="formSearchAuth">
        <div class="row">
          <div class="col-12">
            <div class="filter cm-content-box box-primary">
              <div class="card-body" style="padding: 1rem">
                <div class="row">
                  <div class="col-7">
                    <input type="text" class="form-control" id="authName" name="authName" placeholder="권한 이름">
                  </div>
                  <div class="col-5" style="padding-top: 3px; text-align: right;">
                    <button class="btn btn-success btn-sm" style="margin-right: 5px" type="button" id="btnSaveAuth">등록</button>
                    <button class="btn btn-primary btn-sm" type="button" id="btnSearchAuth">검색</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="row">
        <div class="col-12">
          <div class="card border-0 pb-0">
            <div class="card-body p-1">
              <div class="tree">
                <ul id="authTree">
                  <!-- Tree structure will be dynamically generated -->
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    $(document).ready(function() {
      initAuth();

      $('#btnSearchAuth').on('click', () => {
        selectAuthTree();
      });

      $('#btnSaveAuth').on('click', () => {
        window.location.href = '/ase/createAuth';
      });
    });

    function initAuth() {
      selectAuthTree();
    }

    const selectAuthTree = function() {
      JS_COMMON.callAjaxForm('/ase/selectAuthList', $('#formSearchAuth').serialize(), 'POST', cb_selectAuthTree, true);
    };

    function cb_selectAuthTree(resultData) {
      const authTree = buildTree(resultData.data);
      const treeHtml = generateTreeHtml(authTree);
      $('#authTree').html(treeHtml);
    }

    function buildTree(authData) {
      const tree = {};
      authData.forEach(auth => {
        tree[auth.authId] = { ...auth, children: [] };
      });
      authData.forEach(auth => {
        if (auth.parentAuthId) {
          tree[auth.parentAuthId].children.push(tree[auth.authId]);
        }
      });
      return Object.values(tree).filter(auth => !auth.parentAuthId);
    }

    function generateTreeHtml(tree) {
      let html = '';
      tree.forEach(auth => {
        html += `<li>${auth.authNm}`;
        if (auth.children.length > 0) {
          html += '<ul>' + generateTreeHtml(auth.children) + '</ul>';
        }
        html += '</li>';
      });
      return html;
    }
  </script>

  </body>
</div>
</html>