<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <body>
  <div class="content-body">
    <div class="container-fluid">
      <div class="row">
        <!-- 좌측 권한 그리드 -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">권한 목록</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table" id="authTable">
                  <thead>
                    <tr>
                      <th><b>권한명</b></th>
                    </tr>
                  </thead>
                  <tbody id="tbodyAuthList">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 우측 메뉴 그리드 -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">메뉴 목록</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table" id="menuTable">
                  <thead>
                    <tr>
                      <th><b>메뉴명</b></th>
                      <th><b>메뉴 URL</b></th>
                      <th><b>사용여부</b></th>
                      <th><b>관리</b></th>
                    </tr>
                  </thead>
                  <tbody id="tbodyMenuList">
                  </tbody>
                </table>
              </div>
              <div class="row mt-3">
                <div class="col-12 text-end">
                  <button class="btn btn-primary btn-sm" type="button" id="btnAddMenu">추가</button>
                  <button class="btn btn-success btn-sm" style="margin-left: 5px" type="button" id="btnSaveMenuAuth">저장</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .delete-marked {
      background-color: #ffebee !important;
    }
  </style>

  <script th:inline="javascript">
    let selectedAuthId = '';
    let menuChanges = new Map(); // 변경사항을 추적하는 Map

    $(document).ready(function() {
      init();
      
      $('#btnAddMenu').on('click', function() {
        addNewMenuRow();
      });

      $('#btnSaveMenuAuth').on('click', function() {
        saveMenuAuth();
      });
    });

    function init() {
      // 권한 목록 조회
      $.ajax({
        url: '/ase/auth/selectAuthList',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success && parsedResult.authList) {
              displayAuthList(parsedResult.authList);
            }
          } catch (e) {
            console.error('Error parsing response:', e);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
        }
      });
    }

    function displayAuthList(authList) {
      let innerHtml = '';
      if (!authList || authList.length === 0) {
        innerHtml = '<tr><td colspan="1"><div class="text-center">조회 결과가 없습니다.</div></td></tr>';
      } else {
        authList.forEach(function(auth) {
          innerHtml += `<tr class="auth-row" data-auth-id="${auth.authId}" style="cursor: pointer;">
            <td>${auth.authNm}</td>
          </tr>`;
        });
      }
      $('#tbodyAuthList').html(innerHtml);

      // 권한 행 클릭 이벤트
      $('.auth-row').on('click', function() {
        $('.auth-row').removeClass('table-primary');
        $(this).addClass('table-primary');
        selectedAuthId = $(this).data('auth-id');
        selectAuthMenuList(selectedAuthId);
      });
    }

    function selectAuthMenuList(authId) {
      if (!authId) return;

      $.ajax({
        url: '/ase/auth/selectAuthMenuList',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ authId: authId }),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success) {
              displayMenuList(parsedResult.menuList || []);
            } else {
              alert(parsedResult.message || '메뉴 목록 조회에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
        }
      });
    }

    function displayMenuList(menuList) {
      let innerHtml = '';
      if (!menuList || menuList.length === 0) {
        innerHtml = '<tr><td colspan="4"><div class="text-center">조회 결과가 없습니다.</div></td></tr>';
      } else {
        menuList.forEach(function(menu) {
          const indent = menu.menuLevel ? '&nbsp;'.repeat(menu.menuLevel * 4) : '';
          const isDeleted = menuChanges.get(menu.menuId) === 'DELETE';
          innerHtml += `<tr data-menu-id="${menu.menuId}" class="${isDeleted ? 'delete-marked' : ''}">
            <td>${indent}${menu.menuNm}</td>
            <td>${menu.menuUrl || ''}</td>
            <td>${menu.useYn === 'Y' ? '사용' : '미사용'}</td>
            <td>
              <button type="button" class="btn btn-danger btn-sm" onclick="toggleDeleteMenu('${menu.menuId}')">
                ${isDeleted ? '삭제취소' : '삭제'}
              </button>
            </td>
          </tr>`;
        });
      }
      $('#tbodyMenuList').html(innerHtml);
    }

    function toggleDeleteMenu(menuId) {
      const row = $(`tr[data-menu-id="${menuId}"]`);
      if (menuChanges.get(menuId) === 'DELETE') {
        // 삭제 취소
        menuChanges.delete(menuId);
        row.removeClass('delete-marked');
        row.find('button').text('삭제');
      } else {
        // 삭제 표시
        menuChanges.set(menuId, 'DELETE');
        row.addClass('delete-marked');
        row.find('button').text('삭제취소');
      }
    }

    function addNewMenuRow() {
      if (!selectedAuthId) {
        alert('권한을 선택해주세요.');
        return;
      }

      // 메뉴 목록 조회
      $.ajax({
        url: '/ase/auth/selectMenuList',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ authId: selectedAuthId }),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success && parsedResult.menuList) {
              const menuList = parsedResult.menuList;
              let options = '<option value="">메뉴 선택</option>';
              menuList.forEach(function(menu) {
                const indent = menu.menuLevel ? '&nbsp;'.repeat(menu.menuLevel * 4) : '';
                options += `<option value="${menu.menuId}">${indent}${menu.menuNm}</option>`;
              });

              const newRow = `<tr class="new-menu-row">
                <td colspan="3">
                  <select class="form-control menu-select">
                    ${options}
                  </select>
                </td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm" onclick="removeNewMenuRow(this)">삭제</button>
                </td>
              </tr>`;
              $('#tbodyMenuList').append(newRow);
            } else {
              alert(parsedResult.message || '메뉴 목록 조회에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('메뉴 목록 조회 중 오류가 발생했습니다.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
          alert('메뉴 목록 조회 중 오류가 발생했습니다.');
        }
      });
    }

    function removeNewMenuRow(button) {
      $(button).closest('tr').remove();
    }

    function saveMenuAuth() {
      if (!selectedAuthId) {
        alert('권한을 선택해주세요.');
        return;
      }

      // 삭제된 메뉴 목록
      const deletedMenus = Array.from(menuChanges.entries())
        .filter(([_, action]) => action === 'DELETE')
        .map(([menuId, _]) => menuId);

      // 새로 추가된 메뉴 목록
      const newMenus = [];
      $('.new-menu-row .menu-select').each(function() {
        const menuId = $(this).val();
        if (menuId) {
          newMenus.push({
            menuId: menuId,
            accessYn: 'Y'
          });
        }
      });

      // 기존 메뉴 목록 (삭제되지 않은 것들)
      const existingMenus = [];
      $('#tbodyMenuList tr:not(.new-menu-row)').each(function() {
        const menuId = $(this).data('menu-id');
        if (menuId && !deletedMenus.includes(menuId)) {
          existingMenus.push({
            menuId: menuId,
            accessYn: 'Y'
          });
        }
      });

      const saveData = {
        authId: selectedAuthId,
        menuList: [...existingMenus, ...newMenus],
        deletedMenuIds: deletedMenus
      };

      $.ajax({
        url: '/ase/auth/saveAuthMenu',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(saveData),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success) {
              alert(parsedResult.message || '저장되었습니다.');
              menuChanges.clear();
              selectAuthMenuList(selectedAuthId);
            } else {
              alert(parsedResult.message || '저장에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('응답 데이터 처리 중 오류가 발생했습니다.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
          alert('저장 중 오류가 발생했습니다.');
        }
      });
    }
  </script>

  </body>
</div>
</html> 