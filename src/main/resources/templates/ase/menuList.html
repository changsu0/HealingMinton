<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <body>
  <div class="content-body">
    <div class="container-fluid">
      <form id="formSearchMenu">
        <div class="row">
          <div class="col-12">
            <div class="filter cm-content-box box-primary">
              <div class="card-body" style="padding: 1rem">
                <div class="row">
                  <div class="col-7">
                    <input type="text" class="form-control" id="menuNm" name="menuNm" placeholder="메뉴 이름">
                  </div>
                  <div class="col-5" style="padding-top: 3px; text-align: right;">
                    <button class="btn btn-success btn-sm" style="margin-right: 5px" type="button" id="btnSaveMenu">등록</button>
                    <button class="btn btn-primary btn-sm" type="button" id="btnSearchMenu">검색</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="row">
        <div class="col-12">
          <div class="card border-0 pb-0">
            <div class="card-body p-1">
              <div class="table-responsive">
                <table class="table text-center" id="menuTable">
                  <colgroup>
                    <col style="width: 10%;">
                    <col style="width: 15%;">
                    <col style="width: 10%;">
                    <col style="width: 20%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 15%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th><b>메뉴 ID</b></th>
                      <th><b>메뉴명</b></th>
                      <th><b>상위 메뉴</b></th>
                      <th><b>URL</b></th>
                      <th><b>순서</b></th>
                      <th><b>사용여부</b></th>
                      <th><b>관리</b></th>
                    </tr>
                  </thead>
                  <tbody id="tbodyMenuList">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      init();

      $('#btnSearchMenu').on('click', () => {
        selectGridList();
      });

      $('#btnSaveMenu').on('click', () => {
        window.location.href = '/ase/menu/createMenu';
      });
    });

    function init() {
      selectGridList();
    }

    const selectGridList = function() {
      JS_COMMON.callAjaxForm('/ase/menu/selectMenuList', $('#formSearchMenu').serialize(), 'POST', cb_selectGridList, true);
    };

    function cb_selectGridList(resultData) {
      let innerHtml = '';
      if (resultData.data.length === 0) {
        innerHtml = '<tr><td colspan="9"><div class="timeline-panel text-center" style="display: block;"><h4 style="margin-bottom: 0;">조회 결과가 없습니다.</h4></div></td></tr>';
      } else {
        for (const menu of resultData.data) {
          innerHtml += '<tr>';
          innerHtml += '<td><span class="w-space-no">' + (menu.menuId || '') + '</span></td>';
          innerHtml += '<td>' + (menu.menuNm || '') + '</td>';
          innerHtml += '<td>' + (menu.parentMenuId || '') + '</td>';
          innerHtml += '<td>' + (menu.menuUrl || '') + '</td>';
          innerHtml += '<td>' + (menu.menuOrder || '') + '</td>';
          innerHtml += '<td>' + (menu.useYn === 'Y' ? '사용' : '미사용') + '</td>';
          innerHtml += '<td>';
          innerHtml += '<button type="button" class="btn btn-primary light btn-xxs" onclick="editMenu(\'' + menu.menuId + '\')">수정</button>';
          innerHtml += '<button type="button" class="btn btn-danger light btn-xxs" style="margin-left: 5px;" onclick="deleteMenu(\'' + menu.menuId + '\')">삭제</button>';
          innerHtml += '</td>';
          innerHtml += '</tr>';
        }
      }
      $('#tbodyMenuList').html(innerHtml);
    }

    function deleteMenu(menuId) {
      if (confirm('정말로 이 메뉴를 삭제하시겠습니까?')) {
        JS_COMMON.callAjaxForm('/ase/menu/deleteMenu', { menuId: menuId }, 'POST', function(result) {
          if (result.code === 200) {
            alert(result.successMsg);
            selectGridList();
          } else {
            alert(result.failMsg);
          }
        }, true);
      }
    }

    function editMenu(menuId) {
        // 메뉴 데이터 조회
        $.ajax({
            url: '/ase/menu/selectMenuByMenuId',
            type: 'POST',
            data: { menuId: menuId },
            dataType: 'json',
            success: function(response) {
                console.log('Response:', response); // 응답 데이터 로깅
                if (response.code === 200) {
                    // URL 파라미터로 메뉴 데이터 전달
                    const menuData = encodeURIComponent(JSON.stringify(response.data));
                    window.location.href = '/ase/menu/createMenu?menu=' + menuData;
                } else {
                    alert('메뉴 정보를 가져오는데 실패했습니다: ' + (response.failMsg || '알 수 없는 오류'));
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });
                alert('메뉴 정보를 가져오는데 실패했습니다. 상세: ' + error);
            }
        });
    }
  </script>

  </body>
</div>
</html>