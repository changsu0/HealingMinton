<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <body>
  <div class="content-body">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">메뉴 등록</h4>
            </div>
            <div class="card-body">
              <form id="formCreateMenu">
                <div class="row mb-4">
                  <div class="col-xl-6">
                    <div class="form-group row">
                      <label class="col-lg-4 col-form-label" for="menuId">메뉴 ID
                        <span class="text-danger">*</span>
                      </label>
                      <div class="col-lg-8">
                        <input type="text" class="form-control" id="menuId" name="menuId" required>
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-6">
                    <div class="form-group row">
                      <label class="col-lg-4 col-form-label" for="menuNm">메뉴명
                        <span class="text-danger">*</span>
                      </label>
                      <div class="col-lg-8">
                        <input type="text" class="form-control" id="menuNm" name="menuNm" required>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-xl-6">
                    <div class="form-group row">
                      <label class="col-lg-4 col-form-label" for="parentMenuId">상위 메뉴</label>
                      <div class="col-lg-8">
                        <select class="form-control" id="parentMenuId" name="parentMenuId">
                          <option value="">선택하세요</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-6">
                    <div class="form-group row">
                      <label class="col-lg-4 col-form-label" for="menuUrl">메뉴 URL</label>
                      <div class="col-lg-8">
                        <input type="text" class="form-control" id="menuUrl" name="menuUrl">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-xl-6">
                    <div class="form-group row">
                      <label class="col-lg-4 col-form-label" for="menuOrder">메뉴 순서</label>
                      <div class="col-lg-8">
                        <input type="number" class="form-control" id="menuOrder" name="menuOrder" value="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-6">
                    <div class="form-group row">
                      <label class="col-lg-4 col-form-label" for="useYn">사용 여부</label>
                      <div class="col-lg-8">
                        <select class="form-control" id="useYn" name="useYn">
                          <option value="Y">사용</option>
                          <option value="N">미사용</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12 text-center">
                    <button type="button" class="btn btn-primary me-2" id="btnSave">저장</button>
                    <button type="button" class="btn btn-light" id="btnCancel">취소</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    $(document).ready(function() {
      // URL 파라미터에서 menuId 가져오기
      const urlParams = new URLSearchParams(window.location.search);
      const menuParam = urlParams.get('menu');
      
      if (menuParam) {
        try {
          const menuData = JSON.parse(decodeURIComponent(menuParam));
          // 입력 필드에 데이터 채우기
          $('#menuId').val(menuData.menuId).prop('readonly', true); // menuId는 수정 불가
          $('#menuNm').val(menuData.menuNm);
          $('#parentMenuId').val(menuData.parentMenuId);
          $('#menuUrl').val(menuData.menuUrl);
          $('#menuOrder').val(menuData.menuOrder);
          $('#useYn').val(menuData.useYn);
        } catch (e) {
          console.error('메뉴 데이터 파싱 실패:', e);
        }
      }

      // 상위 메뉴 목록 조회
      loadParentMenus();

      // 저장 버튼 클릭
      $('#btnSave').on('click', function() {
        if (!validateForm()) {
          return;
        }
        
        const menuData = {
          menuId: $('#menuId').val(),
          menuNm: $('#menuNm').val(),
          parentMenuId: $('#parentMenuId').val() || null,
          menuUrl: $('#menuUrl').val(),
          menuOrder: $('#menuOrder').val(),
          useYn: $('#useYn').val(),
          createUserId: 'SYSTEM'  // 임시로 SYSTEM 사용
        };

        JS_COMMON.callAjaxForm('/ase/menu/saveMenu', menuData, 'POST', function(result) {
          if (result.code === 200) {
            alert(result.successMsg);
            window.location.href = '/ase/menu/menuList';
          } else {
            alert(result.failMsg);
          }
        }, true);
      });

      // 취소 버튼 클릭
      $('#btnCancel').on('click', function() {
        window.location.href = '/ase/menu/menuList';
      });
    });

    // 상위 메뉴 목록 조회
    function loadParentMenus() {
      JS_COMMON.callAjaxForm('/ase/menu/selectMenuList', {}, 'POST', function(result) {
        if (result.code === 200) {
          const menus = result.data;
          const select = $('#parentMenuId');
          
          menus.forEach(menu => {
            select.append(new Option(menu.menuNm, menu.menuId));
          });
        }
      }, true);
    }

    // 폼 유효성 검사
    function validateForm() {
      const menuId = $('#menuId').val();
      const menuNm = $('#menuNm').val();
      
      if (!menuId) {
        alert('메뉴 ID를 입력해주세요.');
        $('#menuId').focus();
        return false;
      }
      if (!menuNm) {
        alert('메뉴명을 입력해주세요.');
        $('#menuNm').focus();
        return false;
      }
      return true;
    }
  </script>

  </body>
</div>
</html> 