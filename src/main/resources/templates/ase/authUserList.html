<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <body>
  <div class="content-body">
    <div class="container-fluid">
      <div class="row">
        <!-- 좌측 권한 그리드 -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">권한 목록</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table" id="authTable">
                  <thead>
                    <tr>
                      <th><b>권한명</b></th>
                    </tr>
                  </thead>
                  <tbody id="tbodyAuthList">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 우측 사용자 그리드 -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">사용자 목록</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table" id="userTable">
                  <thead>
                    <tr>
                      <th><b>사용자명</b></th>
                      <th><b>관리</b></th>
                    </tr>
                  </thead>
                  <tbody id="tbodyUserList">
                  </tbody>
                </table>
              </div>
              <div class="row mt-3">
                <div class="col-12 text-end">
                  <button class="btn btn-primary btn-sm" type="button" id="btnAddUser">추가</button>
                  <button class="btn btn-success btn-sm" style="margin-left: 5px" type="button" id="btnSaveUserAuth">저장</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .delete-marked {
      background-color: #ffebee !important;
    }
  </style>

  <script th:inline="javascript">
    let selectedAuthId = '';
    let userChanges = new Map(); // 변경사항을 추적하는 Map

    $(document).ready(function() {
      init();
      
      $('#btnAddUser').on('click', function() {
        addNewUserRow();
      });

      $('#btnSaveUserAuth').on('click', function() {
        saveUserAuth();
      });
    });

    function init() {
      // 권한 목록 조회
      $.ajax({
        url: '/ase/auth/selectAuthList',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success && parsedResult.authList) {
              displayAuthList(parsedResult.authList);
            }
          } catch (e) {
            console.error('Error parsing response:', e);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
        }
      });
    }

    function displayAuthList(authList) {
      let innerHtml = '';
      if (!authList || authList.length === 0) {
        innerHtml = '<tr><td colspan="1"><div class="text-center">조회 결과가 없습니다.</div></td></tr>';
      } else {
        authList.forEach(function(auth) {
          innerHtml += `<tr class="auth-row" data-auth-id="${auth.authId}" style="cursor: pointer;">
            <td>${auth.authNm}</td>
          </tr>`;
        });
      }
      $('#tbodyAuthList').html(innerHtml);

      // 권한 행 클릭 이벤트
      $('.auth-row').on('click', function() {
        $('.auth-row').removeClass('table-primary');
        $(this).addClass('table-primary');
        selectedAuthId = $(this).data('auth-id');
        selectAuthUserList(selectedAuthId);
      });
    }

    function selectAuthUserList(authId) {
      if (!authId) return;

      $.ajax({
        url: '/ase/auth/selectAuthUserList',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ authId: authId }),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success) {
              displayUserList(parsedResult.userList || []);
            } else {
              alert(parsedResult.message || '사용자 목록 조회에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
        }
      });
    }

    function displayUserList(userList) {
      let innerHtml = '';
      if (!userList || userList.length === 0) {
        innerHtml = '<tr><td colspan="4"><div class="text-center">조회 결과가 없습니다.</div></td></tr>';
      } else {
        userList.forEach(function(user) {
          const isDeleted = userChanges.get(user.userUid) === 'DELETE';
          innerHtml += `<tr data-user-uid="${user.userUid}" class="${isDeleted ? 'delete-marked' : ''}">
            <td>${user.userNm}</td>
            <td>
              <button type="button" class="btn btn-danger btn-sm" onclick="toggleDeleteUser('${user.userUid}')">
                ${isDeleted ? '삭제취소' : '삭제'}
              </button>
            </td>
          </tr>`;
        });
      }
      $('#tbodyUserList').html(innerHtml);
    }

    function toggleDeleteUser(userUid) {
      const row = $(`tr[data-user-uid="${userUid}"]`);
      if (userChanges.get(userUid) === 'DELETE') {
        // 삭제 취소
        userChanges.delete(userUid);
        row.removeClass('delete-marked');
        row.find('button').text('삭제');
      } else {
        // 삭제 표시
        userChanges.set(userUid, 'DELETE');
        row.addClass('delete-marked');
        row.find('button').text('삭제취소');
      }
    }

    function addNewUserRow() {
      if (!selectedAuthId) {
        alert('권한을 선택해주세요.');
        return;
      }

      // 사용자 검색 모달 표시
      $('#userSearchModal').modal('show');
    }

    function selectUser(userUid, userNm) {
      // 이미 선택된 사용자인지 확인
      const existingUser = $(`tr[data-user-uid="${userUid}"]`).length > 0;
      if (existingUser) {
        alert('이미 선택된 사용자입니다.');
        return;
      }

      // 사용자 정보 조회
      $.ajax({
        url: '/ase/auth/selectUser',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ userId: userUid }),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success && parsedResult.user) {
              const user = parsedResult.user;
              const newRow = `<tr class="new-user-row" data-user-uid="${user.userUid}">
                <td>${user.userNm}</td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm" onclick="removeNewUserRow(this)">삭제</button>
                </td>
              </tr>`;
              $('#tbodyUserList').append(newRow);
              $('#userSearchModal').modal('hide');
            } else {
              alert(parsedResult.message || '사용자 정보 조회에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('사용자 정보 조회 중 오류가 발생했습니다.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
          alert('사용자 정보 조회 중 오류가 발생했습니다.');
        }
      });
    }

    function removeNewUserRow(button) {
      $(button).closest('tr').remove();
    }

    function saveUserAuth() {
      if (!selectedAuthId) {
        alert('권한을 선택해주세요.');
        return;
      }

      // 삭제된 사용자 목록
      const deletedUsers = Array.from(userChanges.entries())
        .filter(([_, action]) => action === 'DELETE')
        .map(([userUid, _]) => userUid);

      // 새로 추가된 사용자 목록
      const newUsers = [];
      $('.new-user-row').each(function() {
        const userUid = $(this).data('user-uid');
        if (userUid) {
          newUsers.push(userUid);
        }
      });

      // 기존 사용자 목록 (삭제되지 않은 것들)
      const existingUsers = [];
      $('#tbodyUserList tr:not(.new-user-row)').each(function() {
        const userUid = $(this).data('user-uid');
        if (userUid && !deletedUsers.includes(userUid)) {
          existingUsers.push(userUid);
        }
      });

      const saveData = {
        authId: selectedAuthId,
        userIds: [...existingUsers, ...newUsers],
        deletedUserIds: deletedUsers
      };

      $.ajax({
        url: '/ase/auth/saveAuthUser',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(saveData),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.success) {
              alert(parsedResult.message || '저장되었습니다.');
              userChanges.clear();
              selectAuthUserList(selectedAuthId);
            } else {
              alert(parsedResult.message || '저장에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('응답 데이터 처리 중 오류가 발생했습니다.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
          alert('저장 중 오류가 발생했습니다.');
        }
      });
    }
  </script>

  <!-- 사용자 검색 모달 -->
  <div class="modal fade" id="userSearchModal" tabindex="-1" aria-labelledby="userSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userSearchModalLabel">사용자 검색</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" class="form-control" id="searchUserNm" placeholder="사용자명">
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-primary" onclick="searchUsers()">검색</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>사용자명</th>
                  <th>선택</th>
                </tr>
              </thead>
              <tbody id="tbodySearchUserList">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    function searchUsers() {
      const userNm = $('#searchUserNm').val();
      
      $.ajax({
        url: '/ase/user/selectUserList',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ userNm: userNm }),
        success: function(result) {
          let parsedResult;
          try {
            parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
            if (parsedResult.code === 200) {
              displaySearchUserList(parsedResult.data || []);
            } else {
              alert(parsedResult.failMsg || '사용자 검색에 실패했습니다.');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            alert('사용자 검색 중 오류가 발생했습니다.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
          alert('사용자 검색 중 오류가 발생했습니다.');
        }
      });
    }

    function displaySearchUserList(userList) {
      let innerHtml = '';
      if (!userList || userList.length === 0) {
        innerHtml = '<tr><td colspan="2"><div class="text-center">조회 결과가 없습니다.</div></td></tr>';
      } else {
        userList.forEach(function(user) {
          innerHtml += `<tr>
            <td>${user.userNm}</td>
            <td>
              <button type="button" class="btn btn-primary btn-sm" onclick="selectUser('${user.userUid}', '${user.userNm}')">선택</button>
            </td>
          </tr>`;
        });
      }
      $('#tbodySearchUserList').html(innerHtml);
    }
  </script>

  </body>
</div>
</html> 