<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <body>
  <div class="content-body">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">권한 등록</h4>
            </div>
            <div class="card-body">
              <form id="formAuth">
                <div class="row">
                  <div class="col-12">
                    <div class="filter cm-content-box box-primary">
                      <div class="card-body" style="padding: 1rem">
                        <div class="row">
                          <div class="col-12">
                            <div class="form-group">
                              <label for="authId">권한 ID</label>
                              <input type="text" class="form-control" id="authId" name="authId" th:value="${auth?.authId}" required>
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="form-group">
                              <label for="authNm">권한명</label>
                              <input type="text" class="form-control" id="authNm" name="authNm" th:value="${auth?.authNm}" required>
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="form-group">
                              <label for="authDescription">설명</label>
                              <textarea class="form-control" id="authDescription" name="authDescription" rows="3" th:text="${auth?.authDescription}"></textarea>
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="form-group">
                              <label for="useYn">사용여부</label>
                              <select class="form-control" id="useYn" name="useYn" required>
                                <option value="Y" th:selected="${auth?.useYn == 'Y'}">사용</option>
                                <option value="N" th:selected="${auth?.useYn == 'N'}">미사용</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12 text-center">
                    <button type="button" class="btn btn-primary me-2" id="btnSave">저장</button>
                    <button type="button" class="btn btn-light" id="btnCancel">취소</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    $(document).ready(function() {
      // authId가 있는 경우(수정 모드) readonly 설정
      const authId = /*[[${auth?.authId}]]*/ null;
      if (authId) {
        $('#authId').prop('readonly', true);
      }

      // 저장 버튼 클릭
      $('#btnSave').on('click', function() {
        if (!validateForm()) {
          return;
        }
        
        const authData = {
          authId: $('#authId').val() || '',
          authNm: $('#authNm').val() || '',
          authDescription: $('#authDescription').val() || '',
          useYn: $('#useYn').val() || 'Y',
          createUserId: 'SYSTEM'  // 임시로 SYSTEM 사용
        };

        console.log('Sending auth data:', authData); // 디버깅을 위한 로그 추가

        $.ajax({
          url: '/ase/auth/saveAuth',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(authData),
          success: function(result) {
            console.log('Raw response:', result); // 원본 응답 로깅
            let parsedResult;
            try {
              parsedResult = typeof result === 'string' ? JSON.parse(result) : result;
              console.log('Parsed result:', parsedResult); // 파싱된 결과 로깅
              
              if (parsedResult.success) {
                alert(parsedResult.message || '저장되었습니다.');
                window.location.href = '/ase/auth/authList';
              } else {
                alert(parsedResult.message || '저장에 실패했습니다.');
              }
            } catch (e) {
              console.error('Error parsing response:', e);
              alert('응답 데이터 처리 중 오류가 발생했습니다.');
            }
          },
          error: function(xhr, status, error) {
            console.error('Error details:', {
              status: status,
              error: error,
              response: xhr.responseText
            });
            alert('저장 중 오류가 발생했습니다.');
          }
        });
      });

      // 취소 버튼 클릭
      $('#btnCancel').on('click', function() {
        window.location.href = '/ase/auth/authList';
      });
    });

    // 폼 유효성 검사
    function validateForm() {
      const authId = $('#authId').val();
      const authNm = $('#authNm').val();
      
      if (!authId) {
        alert('권한 ID를 입력해주세요.');
        $('#authId').focus();
        return false;
      }
      if (!authNm) {
        alert('권한명을 입력해주세요.');
        $('#authNm').focus();
        return false;
      }
      return true;
    }
  </script>

  </body>
</div>
</html> 