<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <body>
    <div class="content-body">
        <div class="container-fluid">
            <form id="formSearchPlace">
                <div class="row">
                    <div class="col-12">
                        <div class="filter cm-content-box box-primary">
                            <div class="card-body" style="padding: 1rem">
                                <div class="row">
                                    <div class="col-7">
                                        <input type="text" class="form-control" id="placeName" name="placeName" placeholder="장소 이름">
                                    </div>
                                    <div class="col-5" style="padding-top: 3px; text-align: right;">
                                        <button class="btn btn-success btn-sm" style="margin-right: 5px" type="button" id="btnSavePlace">등록</button>
                                        <button class="btn btn-primary btn-sm" type="button" id="btnSearchPlace">검색</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <div class="row">
                <div class="col-12">
                    <div class="card border-0 pb-0">
                        <div class="card-body p-1">
                            <div class="table-responsive">
                                <table class="table text-center" id="placeTable">
                                    <colgroup>
                                        <col style="width: 10%;">
                                        <col style="width: 15%;">
<!--                                        <col style="width: 10%;">-->
                                        <col style="width: 20%;">
                                        <col style="width: 8%;">
                                        <col style="width: 8%;">
                                        <col style="width: 15%;">
                                        <col style="width: 8%;">
                                    </colgroup>
                                    <thead>
                                    <tr>
                                        <th><b>장소 ID</b></th>
                                        <th><b>장소명</b></th>
<!--                                        <th><b>상위 메뉴</b></th>-->
                                        <th><b>장소 위치</b></th>
                                        <th><b>등록 일자</b></th>
                                        <th><b>수정 일자</b></th>
                                        <th><b>관리</b></th>
                                        <th><b></b></th>
                                    </tr>
                                    </thead>
                                    <tbody id="tbodyPlaceList">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            init();

            $('#btnSearchPlace').on('click', () => {
                selectGridList();
            });

            $('#btnSavePlace').on('click', () => {
                window.location.href = '/place/createPlace';
            });
        });

        function init() {
            selectGridList();
        }

        const selectGridList = function() {
            JS_COMMON.callAjaxForm('/place/selectPlaceList', $('#formSearchPlace').serialize(), 'POST', cb_selectGridList, true);
        };

        function cb_selectGridList(resultData) {
            let innerHtml = '';
            if (resultData.data.length === 0) {
                innerHtml = '<tr><td colspan="9"><div class="timeline-panel text-center" style="display: block;"><h4 style="margin-bottom: 0;">조회 결과가 없습니다.</h4></div></td></tr>';
            } else {
                for (const place of resultData.data) {
                    innerHtml += '<tr>';
                    innerHtml += '<td><span class="w-space-no">' + (place.placeId || '') + '</span></td>';
                    innerHtml += '<td>' + (place.placeName || '') + '</td>';
                    // innerHtml += '<td>' + (menu.parentMenuId || '') + '</td>';
                    innerHtml += '<td>' + (place.placeAddress || '') + '</td>';
                    innerHtml += '<td>' + (place.createDate || '') + '</td>';
                    innerHtml += '<td>' + (place.updateDate || '') + '</td>';
                    innerHtml += '<td>';
                    innerHtml += '<button type="button" class="btn btn-primary light btn-xxs" onclick="editPlace(\'' + place.placeId + '\')">수정</button>';
                    innerHtml += '<button type="button" class="btn btn-danger light btn-xxs" style="margin-left: 5px;" onclick="deletePlace(\'' + place.placeId + '\')">삭제</button>';
                    innerHtml += '</td>';
                    innerHtml += '<td>';
                    innerHtml += '<button type="button" class="btn btn-success" style="margin-left: 5px;" onclick="ReservationPlace(\'' + place.placeId + '\')">예약</button>';
                    innerHtml += '</td>';
                    innerHtml += '</tr>';
                }
            }
            $('#tbodyPlaceList').html(innerHtml);
        }

        function deletePlace(placeId) {
            if (confirm('정말로 이 메뉴를 삭제하시겠습니까?')) {
                JS_COMMON.callAjaxForm('/place/deletePlace', { placeId: placeId }, 'POST', function(result) {
                    if (result.code === 200) {
                        alert(result.successMsg);
                        selectGridList();
                    } else {
                        alert(result.failMsg);
                    }
                }, true);
            }
        }

        function editPlace(placeId) {
            // 메뉴 데이터 조회
            $.ajax({
                url: '/place/selectPlaceByPlaceId',
                type: 'POST',
                data: { placeId: placeId },
                dataType: 'json',
                success: function(response) {
                    console.log('Response:', response); // 응답 데이터 로깅
                    if (response.code === 200) {
                        // URL 파라미터로 메뉴 데이터 전달
                        const placeData = encodeURIComponent(JSON.stringify(response.data));
                        window.location.href = '/place/createPlace?place=' + placeData;
                    } else {
                        alert('메뉴 정보를 가져오는데 실패했습니다: ' + (response.failMsg || '알 수 없는 오류'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    alert('메뉴 정보를 가져오는데 실패했습니다. 상세: ' + error);
                }
            });
        }

        function ReservationPlace(placeId) {
            // 장소 예약
            $.ajax({
                url: '/place/selectPlaceByPlaceId',
                type: 'POST',
                data: { placeId: placeId },
                dataType: 'json',
                success: function(response) {
                    console.log('Response:', response); // 응답 데이터 로깅
                    if (response.code === 200) {
                        // URL 파라미터로 메뉴 데이터 전달
                        const placeData = encodeURIComponent(JSON.stringify(response.data));
                        window.location.href = '/placeReservation/createPlaceReservation?place=' + placeData;
                    } else {
                        alert('메뉴 정보를 가져오는데 실패했습니다: ' + (response.failMsg || '알 수 없는 오류'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    alert('메뉴 정보를 가져오는데 실패했습니다. 상세: ' + error);
                }
            });
        }
    </script>

    </body>
</div>
</html>