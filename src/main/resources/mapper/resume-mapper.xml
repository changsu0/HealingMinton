<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.corelabs.resume.mapper.ResumeMapper">

    <select id="selectResumeList" resultType="map">
        /* ResumeMapper.selectResumeList */
        SELECT
        r.resume_id AS resumeId,
        r.name,
        cd.dtl_nm AS gender,
        IFNULL(CONCAT(TIMESTAMPDIFF(YEAR, r.birth, CURDATE()) + 1, '세'), '데이터 없음') AS age,
        IFNULL(r.military, '데이터 없음') AS military,
        IFNULL(r.marriage, '데이터 없음') AS marriage,
        IFNULL(r.address, '데이터 없음') AS address,
        IFNULL(e.final_edu, '데이터 없음') AS finalEdu,
        IFNULL(l.license_summary, '데이터 없음') AS licenseSummary,
        IFNULL(CONCAT(FLOOR(c.total_months / 12),'년 ', MOD(c.total_months, 12), '개월'), '신입') AS formattedPeriod,
        IFNULL(s.top_skill, '데이터 없음') AS topSkill,
        DATE_FORMAT(IFNULL(r.updated_time, r.created_time), '%Y-%m-%d') AS lastUpdatedTime
        FROM resume r
        -- 1. 학력: 최신 학력 1건 추출
        LEFT JOIN (
        SELECT resume_id, CONCAT(school_name, '(', school_status, ')') AS final_edu
        FROM (
        SELECT resume_id, school_name, school_status,
        ROW_NUMBER() OVER(PARTITION BY resume_id ORDER BY school_date DESC) as rn
        FROM resume_education
        ) t WHERE rn = 1
        ) e ON r.resume_id = e.resume_id
        -- 2. 자격증: 대표 자격증 및 외 N종 요약
        LEFT JOIN (
        SELECT resume_id,
        CONCAT(SUBSTR(MAX(CASE WHEN license_name LIKE '%기사%' THEN CONCAT('3', license_name)
        WHEN license_name LIKE '%SQL%' THEN CONCAT('2', license_name)
        ELSE CONCAT('1', license_name) END), 2),
        IF(COUNT(*) > 1, CONCAT(' 외 ', COUNT(*) - 1, '종'), '')) AS license_summary
        FROM resume_license
        GROUP BY resume_id
        ) l ON r.resume_id = l.resume_id
        -- 3. 경력: 총 경력 합산
        LEFT JOIN (
        SELECT resume_id, SUM(TIMESTAMPDIFF(MONTH, company_start_term, IFNULL(company_end_term, CURDATE()))) AS total_months
        FROM resume_career
        GROUP BY resume_id
        ) c ON r.resume_id = c.resume_id
        -- 4. 기술: 가장 많이 사용된 언어 추출
        LEFT JOIN (
        SELECT resume_id, project_language AS top_skill
        FROM (
        SELECT resume_id, project_language,
        ROW_NUMBER() OVER(PARTITION BY resume_id ORDER BY COUNT(*) DESC, project_language) as rn
        FROM resume_skill
        GROUP BY resume_id, project_language
        ) t WHERE rn = 1
        ) s ON r.resume_id = s.resume_id
        -- 5. 성별 공통 코드 (LEFT JOIN)
        LEFT JOIN (
        SELECT dtl_cd, dtl_nm
        FROM comm_cd_dtl
        WHERE com_cd = 'SEX_TYPE' AND use_yn = 'Y'
        ) cd ON r.gender = cd.dtl_cd

        <where>
            <if test="name != null and name != ''">AND r.name LIKE CONCAT('%', #{name}, '%')</if>
            <if test="gender != null and gender != ''">AND r.gender = #{gender}</if>
            <if test="birth != null and birth != ''">AND r.birth LIKE CONCAT('%', #{birth}, '%')</if>
            <if test="role != null and role != ''">AND r.role LIKE CONCAT('%', #{role}, '%')</if>
            <if test="military != null and military != ''">AND r.military LIKE CONCAT('%', #{military}, '%')</if>
            <if test="marriage != null and marriage != ''">AND r.marriage LIKE CONCAT('%', #{marriage}, '%')</if>
            <if test="landlineNumber != null and landlineNumber != ''">AND r.landline_number LIKE CONCAT('%', #{landlineNumber}, '%')</if>
            <if test="phoneNumber != null and phoneNumber != ''">AND r.phone_number LIKE CONCAT('%', #{phoneNumber}, '%')</if>
            <if test="email != null and email != ''">AND r.email LIKE CONCAT('%', #{email}, '%')</if>
            <if test="address != null and address != ''">AND r.address LIKE CONCAT('%', #{address}, '%')</if>

            <if test="(schoolName != null and schoolName != '') or
                      (schoolStatus != null and schoolStatus != '') or
                      (schoolDate != null and schoolDate != '')">
                AND EXISTS (
                SELECT 1 FROM resume_education edu WHERE edu.resume_id = r.resume_id
                <if test="schoolName != null and schoolName != ''">AND edu.school_name LIKE CONCAT('%', #{schoolName}, '%')</if>
                <if test="schoolStatus != null and schoolStatus != ''">AND edu.school_status = #{schoolStatus}</if>
                <if test="schoolDate != null and schoolDate != ''">AND edu.school_date LIKE CONCAT('%', #{schoolDate}, '%')</if>
                )
            </if>

            <if test="licenseName != null and licenseName != '' or
                      licenseIssuer != null and licenseIssuer != '' or
                      licenseDate != null and licenseDate != ''">
                AND EXISTS (
                SELECT 1 FROM resume_license lic WHERE lic.resume_id = r.resume_id
                <if test="licenseName != null and licenseName != ''">AND lic.license_name LIKE CONCAT('%', #{licenseName}, '%')</if>
                <if test="licenseIssuer != null and licenseIssuer != ''">AND lic.license_issuer LIKE CONCAT('%', #{licenseIssuer}, '%')</if>
                <if test="licenseDate != null and licenseDate != ''">AND lic.license_date LIKE CONCAT('%', #{licenseDate}, '%')</if>
                )
            </if>

            <if test="companyName != null and companyName != '' or
                      companyRole != null and companyRole != '' or
                      companyWork != null and companyWork != '' or
                      companyStartTerm != null and companyStartTerm != '' or
                      companyEndTerm != null and companyEndTerm != ''">
                AND EXISTS (
                SELECT 1 FROM resume_career car WHERE car.resume_id = r.resume_id
                <if test="companyName != null and companyName != ''">AND car.company_name LIKE CONCAT('%', #{companyName}, '%')</if>
                <if test="companyRole != null and companyRole != ''">AND car.company_role LIKE CONCAT('%', #{companyRole}, '%')</if>
                <if test="companyWork != null and companyWork != ''">AND car.company_work LIKE CONCAT('%', #{companyWork}, '%')</if>
                <if test="companyStartTerm != null and companyStartTerm != ''">AND car.company_start_term LIKE CONCAT('%', #{companyStartTerm}, '%')</if>
                <if test="companyEndTerm != null and companyEndTerm != ''">AND car.company_end_term LIKE CONCAT('%', #{companyEndTerm}, '%')</if>
                )
            </if>

            <if test="projectName != null and projectName != '' or
                      projectCustomer != null and projectCustomer != '' or
                      projectCompany != null and projectCompany != '' or
                      projectWork != null and projectWork != '' or
                      projectLanguage != null and projectLanguage != '' or
                      projectDb != null and projectDb != '' or
                      projectTool != null and projectTool != '' or
                      projectFramework != null and projectFramework != '' or
                      projectStartTerm != null and projectStartTerm != '' or
                      projectEndTerm != null and projectEndTerm != '' or
                      projectEtc != null and projectEtc != '' or
                      projectWorkDetail != null and projectWorkDetail != ''">
                AND EXISTS (
                SELECT 1 FROM resume_skill sk WHERE sk.resume_id = r.resume_id
                <if test="projectName != null and projectName != ''">AND LOWER(sk.project_name) LIKE LOWER(CONCAT('%', #{projectName}, '%'))</if>
                <if test="projectCustomer != null and projectCustomer != ''">AND LOWER(sk.project_customer) LIKE LOWER(CONCAT('%', #{projectCustomer}, '%'))</if>
                <if test="projectCompany != null and projectCompany != ''">AND LOWER(sk.project_company) LIKE LOWER(CONCAT('%', #{projectCompany}, '%'))</if>
                <if test="projectWork != null and projectWork != ''">AND LOWER(sk.project_work) LIKE LOWER(CONCAT('%', #{projectWork}, '%'))</if>
                <if test="projectLanguage != null and projectLanguage != ''">AND LOWER(sk.project_language) LIKE LOWER(CONCAT('%', #{projectLanguage}, '%'))</if>
                <if test="projectDb != null and projectDb != ''">AND LOWER(sk.project_db) LIKE LOWER(CONCAT('%', #{projectDb}, '%'))</if>
                <if test="projectTool != null and projectTool != ''">AND LOWER(sk.project_tool) LIKE LOWER(CONCAT('%', #{projectTool}, '%'))</if>
                <if test="projectFramework != null and projectFramework != ''">AND LOWER(sk.project_framework) LIKE LOWER(CONCAT('%', #{projectFramework}, '%'))</if>
                <if test="projectStartTerm != null and projectStartTerm != ''">AND sk.project_start_term LIKE LOWER(CONCAT('%', #{projectStartTerm}, '%'))</if>
                <if test="projectEndTerm != null and projectEndTerm != ''">AND sk.project_end_term LIKE LOWER(CONCAT('%', #{projectEndTerm}, '%'))</if>
                <if test="projectEtc != null and projectEtc != ''">AND LOWER(sk.project_etc) LIKE LOWER(CONCAT('%', #{projectEtc}, '%'))</if>
                <if test="projectWorkDetail != null and projectWorkDetail != ''">AND LOWER(sk.project_work_detail) LIKE LOWER(CONCAT('%', #{projectWorkDetail}, '%'))</if>
                )
            </if>

        </where>
        ORDER BY IFNULL(r.updated_time, r.created_time) DESC
    </select>

    <insert id="insertResume" parameterType="resumeVO">
        /* ResumeMapper.insertResume */
        INSERT INTO resume
        (
         resume_id,
         title,
         created_user,
         created_time,
         updated_time,
         name,
         birth,
         gender,
         military,
         role,
         marriage,
         landline_number,
         phone_number,
         email,
         address
        )
        VALUES
        (
         #{resumeId},
         #{title},
         #{createdUser},
         NOW(),
         NULL,
         #{name},
         NULLIF(#{birth}, ''),
         #{gender},
         #{military},
         #{role},
         #{marriage},
         #{landlineNumber},
         #{phoneNumber},
         #{email},
         #{address}
        )
    </insert>

    <insert id="insertEducation" parameterType="resumeEducationVO">
        /* ResumeMapper.insertEducation */
        INSERT INTO resume_education
        (
         school_name,
         school_status,
         school_date,
         created_time,
         resume_id
        )
        VALUES
        (
         #{schoolName},
         #{schoolStatus},
         NULLIF(#{schoolDate}, ''),
         NOW(),
         #{resumeId}
        )
    </insert>

    <insert id="insertCareer" parameterType="resumeCareerVO">
        /* ResumeMapper.insertCareer */
        INSERT INTO resume_career
        (
         company_name,
         company_role,
         company_work,
         company_start_term,
         company_end_term,
         created_time,
         resume_id
        )
        VALUES
        (
         #{companyName},
         #{companyRole},
         #{companyWork},
         NULLIF(#{companyStartTerm}, ''),
         NULLIF(#{companyEndTerm}, ''),
         NOW(),
         #{resumeId}
        )
    </insert>

    <insert id="insertLicense" parameterType="resumeLicenseVO">
        /* ResumeMapper.insertLicense */
        INSERT INTO resume_license
        (
         license_name,
         license_issuer,
         license_date,
         created_time,
         resume_id
        )
        VALUES
        (
         #{licenseName},
         #{licenseIssuer},
         NULLIF(#{licenseDate}, ''),
         NOW(),
         #{resumeId}
        )
    </insert>

    <insert id="insertSkill" parameterType="resumeSkillVO">
        /* ResumeMapper.insertSkill */
        INSERT INTO resume_skill
        (
         project_name,
         project_customer,
         project_company,
         project_work,
         project_language,
         project_db,
         project_tool,
         project_framework,
         project_start_term,
         project_end_term,
         project_work_detail,
         project_etc,
         created_time,
         resume_id)
        VALUES
        (
         #{projectName},
         #{projectCustomer},
         #{projectCompany},
         #{projectWork},
         #{projectLanguage},
         #{projectDb},
         #{projectTool},
         #{projectFramework},
         STR_TO_DATE(
                 CASE
                     WHEN #{projectStartTerm} IS NULL OR #{projectStartTerm} = '' THEN NULL
                     WHEN LENGTH(#{projectStartTerm}) = 7 THEN CONCAT(#{projectStartTerm}, '-01')
                     ELSE #{projectStartTerm}
                     END,
                 '%Y-%m-%d'
             ),
         STR_TO_DATE(
                 CASE
                     WHEN #{projectEndTerm} IS NULL OR #{projectEndTerm} = '' THEN NULL
                     WHEN LENGTH(#{projectEndTerm}) = 7 THEN CONCAT(#{projectEndTerm}, '-01')
                     ELSE #{projectEndTerm}
                     END,
                 '%Y-%m-%d'
         ),
         #{projectWorkDetail},
         #{projectEtc},
         NOW(),
         #{resumeId}
        )
    </insert>

    <select id="selectResumeById">
        /* ResumeMapper.selectResumeById */
        SELECT
            r.resume_id AS resumeId,
            r.title,
            r.created_user AS createdUser,
            r.created_time AS createdTime,
            r.updated_time AS updatedTime,
            r.name,
            r.birth,
            r.gender,
            r.military,
            r.role,
            r.marriage,
            r.landline_number AS landlineNumber,
            r.phone_number AS phoneNumber,
            r.email,
            r.address
        FROM resume r
        LEFT JOIN (
            SELECT dtl_cd, dtl_nm
            FROM comm_cd_dtl
            WHERE com_cd = 'SEX_TYPE'
            AND use_yn = 'Y'
            ) cd ON r.gender = cd.dtl_cd
        WHERE r.resume_id = #{resumeId}
        ORDER BY created_time DESC
    </select>
    
    <select id="selectEducationById" resultType="resumeEducationVO">
        /* ResumeMapper.selectEducationById */
        SELECT
            id AS resumeEducationId,
            school_name AS schoolName,
            school_status AS schoolStatus,
            school_date AS schoolDate
        FROM resume_education
        WHERE resume_id = #{resumeId}
        ORDER BY school_date DESC
    </select>
    
    <select id="selectCareerById" resultType="resumeCareerVO">
        /* ResumeMapper.selectCareerById */
        SELECT
            id AS resumeCareerId,
            company_name AS companyName,
            company_role AS companyRole,
            company_work AS companyWork,
            company_start_term AS companyStartTerm,
            company_end_term AS companyEndTerm
        FROM resume_career
        WHERE resume_id = #{resumeId}
        ORDER BY company_start_term DESC
    </select>

    <select id="selectLicenseById" resultType="resumeLicenseVO">
        /* ResumeMapper.selectLicenseById */
        SELECT
            id AS resumeLicenseId,
            license_name AS licenseName,
            license_issuer AS licenseIssuer,
            license_date AS licenseDate
        FROM resume_license
        WHERE resume_id = #{resumeId}
        ORDER BY license_date DESC
    </select>

    <select id="selectSkillById" resultType="resumeSkillVO">
        /* ResumeMapper.selectSkillById */
        SELECT
            id AS resumeSkillId,
            project_name AS projectName,
            project_customer AS projectCustomer,
            project_company AS projectCompany,
            project_work AS projectWork,
            project_language AS projectLanguage,
            project_db AS projectDb,
            project_tool AS projectTool,
            project_framework AS projectFramework,
            project_start_term AS projectStartTerm,
            project_end_term AS projectEndTerm,
            project_work_detail AS projectWorkDetail,
            project_etc AS projectEtc
        FROM resume_skill
        WHERE resume_id = #{resumeId}
        ORDER BY project_start_term DESC
    </select>

    <update id="updateResume" parameterType="resumeVO">
        /* ResumeMapper.updateResume */
        UPDATE resume
        SET title = #{title},
            created_user = #{createdUser},
            updated_time = NOW(),
            name = #{name},
            birth = NULLIF(#{birth}, ''),
            gender = #{gender},
            military = #{military},
            role = #{role},
            marriage = #{marriage},
            landline_number = #{landlineNumber},
            phone_number = #{phoneNumber},
            email = #{email},
            address = #{address}
        WHERE resume_id = #{resumeId}
    </update>

    <delete id="deleteResume" parameterType="string">
        /* ResumeMapper.deleteResume */
        DELETE FROM resume WHERE resume_id = #{resumeId}
    </delete>

    <delete id="deleteEducation" parameterType="string">
        /* ResumeMapper.deleteEducation */
        DELETE FROM resume_education WHERE resume_id = #{resumeId}
    </delete>

    <delete id="deleteCareer" parameterType="string">
        /* ResumeMapper.deleteCareer */
        DELETE FROM resume_career WHERE resume_id = #{resumeId}
    </delete>

    <delete id="deleteLicense" parameterType="string">
        /* ResumeMapper.deleteLicense */
        DELETE FROM resume_license WHERE resume_id = #{resumeId}
    </delete>

    <delete id="deleteSkill" parameterType="string">
        /* ResumeMapper.deleteSkill */
        DELETE FROM resume_skill WHERE resume_id = #{resumeId}
    </delete>

    <select id="selectCommonList" resultType="commonDetail">
        /* ResumeMapper.selectCommonDtlList */
        SELECT
            com_cd,
            dtl_cd,
            dtl_nm,
            dtl_desc,
            dtl_order_no,
            use_yn,
            create_user_id,
            create_dt,
            update_user_id,
            update_dt
        FROM comm_cd_dtl
        WHERE com_cd = #{comCd}
        AND use_yn = 'Y'
        ORDER BY dtl_order_no
    </select>
</mapper>